= ECA EXTERNAL API
:toc:
:toc-title: Оглавление

== Введение

В данном документе приведено описание внешнего REST API для построения одиночных и ансамблевых моделей классификаторов.
API предоставляет следующие методы:

* Загрузка обучающей выборки на сервер
* Построение модели классификатора с заданными настройками для конкретной обучающей выборки.
* Построение эксперимента для автоматического подбора оптимальных параметров для классификаторов
* Скачивание файла с построенной моделью классификатора

== 1. Список доступных методов

|===
|Endpoint|Тип запроса|Описание|Формат запроса|Формат ответа
|http://eca-service:8080/external-api/uploads-train-data
|POST
|Загрузка файла с обучающей выборкой на сервер
|multipart/form-data
|application/json
|http://eca-service:8080/external-api/optimal-evaluation-request
|POST
|Создание запроса на построение модели классификатора с использованием оптимальных параметров
|application/json
|application/json
|http://eca-service:8080/external-api/evaluation-request
|POST
|Создание запроса на построение модели классификатора
|application/json
|application/json
|http://eca-service:8080/external-api/experiment-request
|POST
|Создание заявки на построение эксперимента
|application/json
|application/json
|http://eca-service:8080/external-api/evaluation-results/{requestId}
|POST
|Запрос на получение результатов построения модели классификатора
|application/json
|application/json
|http://eca-service:8080/external-api/experiment-results/{requestId}
|POST
|Запрос на получение результатов эксперимента
|application/json
|application/json
|===

== 2. Получение токена доступа к API

Авторизация клиентского приложения осуществляется по протоколу oauth2. Все запросы к API должны сопровождаться авторизационным токеном в заголовке запроса:

Authorization: Bearer YOUR_TOKEN

Для получения авторизационного токена необходимо выполнить следующий запрос:

[source,bash]
----
curl external-api:external_api_secret@eca-service:8080/eca-oauth/oauth/token -d grant_type=client_credentials
----

где external-api:external_api_secret - пара clientId и clientSecret

Запрос возвращает access_token для доступа к API:

[source,json]
----
{
  "access_token": "cf4cd583-b9f1-4dce-8dcc-afefd1510974",
  "token_type": "bearer",
  "expires_in": 2591999,
  "scope": "external-api"
}
----

где expires_in - время жизни access_token в секундах.

== 3. Описание формата запросов

==== 3.1. Пример загрузки обучающей выборки на сервер

[source,bash]
----
curl -X POST "http://localhost:8080/external-api/uploads-train-data" -H "accept: */*" -H "authorization: Bearer cf4cd583-b9f1-4dce-8dcc-afefd1510974" -H "Content-Type: multipart/form-data" -F "trainingData=@iris.xls;type=application/vnd.ms-excel"
----

* Примечание: размер файла не должен превышать 10мб.
* Примечание: допускаются только файлы форматов csv, xls, xlsx, arff, json, docx, data, txt
* Примечание: данные на сервере хранятся 14 дней

==== 3.2. Пример ответа на запрос о загрузке обучающей выборки на сервер

[source,json]
----
{
  "payload": {
    "dataId": "2a35bffe-27ad-4a50-a7e0-8c871cfd7cc5",
    "dataUrl": "data://2a35bffe-27ad-4a50-a7e0-8c871cfd7cc5"
  },
  "responseCode": "SUCCESS",
  "errorDescription": null
}
----

==== 3.3. Описание параметров ответа на запрос о загрузке обучающей выборки на сервер

|===
|Название поля/атрибута|Тип|Обязательное|Описание|Комментарий
|dataId
|string
|+
|Уникальный идентификатор данных
|
|dataUrl
|string
|+
|Внутренняя ссылка на данные в формате data://dataId
|Ссылка может быть передана в поле trainDataUrl для запроса на построение модели классификатора
|responseCode
|string
|+
|Статус ответа
|Заполняется по справочнику <<Справочник кодов ответа>>
|===

==== 3.4. Пример запроса на построение модели классификатора

[source,json]
----
{
  "trainDataUrl": "http://kt.ijs.si/Branax/Repository/WEKA/Iris.xls",
  "classifierOptions": {
    "type": "logistic",
    "maxIts": 200,
    "useConjugateGradientDescent": false
  },
  "evaluationMethod": "CROSS_VALIDATION",
  "numFolds": 10,
  "numTests": 1,
  "seed": 1
}
----

==== 3.5. Описание параметров запроса на построение модели классификатора

|===
|Название поля/атрибута|Тип|Обязательное|Описание|Комментарий
|trainDataUrl
|string
|+
|Ссылка на обучающую выборку
|Может быть передана ссылка на внешний источник, например http или ftp, так и ссылка на файл с данными на сервере в формате data://DATA_ID
|classifierOptions
|ClassifierOptions
|+
|JSON конфигурация классификатора
|подробнее в link:classifiers-options.adoc[]
|evaluationMethod
|string
|+
|Метод оценки точности
|Заполняется по справочнику <<Справочник значений EvaluationMethod>>
|numFolds
|integer
|-
|Число блоков для метода V - блочной кросс проверки
|
|numTests
|integer
|-
|Число тестов для метода V - блочной кросс проверки
|
|seed
|integer
|-
|Начальное значение для генератора псевдослучайных чисел
|
|===

==== 3.6. Пример ответа на запрос построения модели классификатора

[source,json]
----
{
  "payload": {
    "requestId": "1cbe6c49-8432-4c81-9afa-90f04a803fed",
    "evaluationStatus": "IN_PROGRESS",
    "errorCode": null
  },
  "responseCode": "SUCCESS",
  "errorDescription": null
}
----

==== 3.7. Описание параметров ответа на запрос построения модели классификатора

|===
|Название поля/атрибута|Тип|Обязательное|Описание|Комментарий
|requestId
|string
|+
|Уникальный идентификатор запроса
|
|evaluationStatus
|string
|+
|Статус построения модели
|Заполняется по справочнику <<Справочник кодов EvaluationStatus>>
|responseCode
|string
|+
|Статус ответа
|Заполняется по справочнику <<Справочник кодов ответа>>
|errorCode
|string
|-
|Код ошибки
|
|===

==== 3.8. Пример запроса на построение модели классификатора с использованием оптимальных параметров

[source,json]
----
{
  "trainDataUrl": "http://kt.ijs.si/Branax/Repository/WEKA/Iris.xls"
}
----

==== 3.9. Описание параметров запроса на построение модели классификатора с использованием оптимальных параметров

|===
|Название поля/атрибута|Тип|Обязательное|Описание|Комментарий
|trainDataUrl
|string
|+
|Ссылка на обучающую выборку
|Может быть передана ссылка на внешний источник, например http или ftp, так и ссылка на файл с данными на сервере в формате data://DATA_ID
|===

==== 3.10. Пример ответа на запрос построения модели классификатора с использованием оптимальных параметров

[source,json]
----
{
  "payload": {
    "requestId": "1cbe6c49-8432-4c81-9afa-90f04a803fed",
    "evaluationStatus": "IN_PROGRESS",
    "errorCode": null
  },
  "responseCode": "SUCCESS",
  "errorDescription": null
}
----

Описание полей ответа приведено в п. 3.7.

==== 3.11. Пример запроса на получение результатов построения модели

[source,bash]
----
curl -X GET "http://localhost:8080/external-api/evaluation-results/1cbe6c49-8432-4c81-9afa-90f04a803fed" -H "accept: */*" -H "authorization: Bearer cf4cd583-b9f1-4dce-8dcc-afefd1510974"
----

==== 3.12. Пример ответа на запрос получения результатов построения модели

[source,json]
----
{
  "payload": {
    "requestId": "1cbe6c49-8432-4c81-9afa-90f04a803fed",
    "evaluationStatus": "FINISHED",
    "errorCode": null,
    "modelUrl": "http://localhost:8098/object-storage/eca-service/classifier-0f45c641-48e1-4f8f-a461-38c27a4befc3.model?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=minio%2F20220727%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20220727T061714Z&X-Amz-Expires=604800&X-Amz-SignedHeaders=host&X-Amz-Signature=2ebb2d403962381a141efaf28767fe3ef622ce1477d9bd2f914560561579325c",
    "numTestInstances": 150,
    "numCorrect": 144,
    "numIncorrect": 6,
    "pctCorrect": 96,
    "pctIncorrect": 4,
    "meanAbsoluteError": 0.02869334024628254
  },
  "responseCode": "SUCCESS",
  "errorDescription": null
}
----

==== 3.13. Описание параметров ответа на запрос получения результатов построения модели

|===
|Название поля/атрибута|Тип|Обязательное|Описание|Комментарий
|requestId
|string
|+
|Уникальный идентификатор запроса
|
|evaluationStatus
|string
|+
|Статус построения модели
|Заполняется по справочнику <<Справочник кодов EvaluationStatus>>
|responseCode
|string
|+
|Статус ответа
|Заполняется по справочнику <<Справочник кодов ответа>>
|errorCode
|string
|-
|Код ошибки
|
|modelUrl
|string
|-
|Ссылка на скачивание модели из S3. Ссылка действительна в течении 7 дней.
|Заполняется при evaluationStatus = FINISHED
|numTestInstances
|integer
|-
|Число объектов тестовых данных
|Заполняется при evaluationStatus = FINISHED
|numCorrect
|integer
|-
|Число верно классифицированных объектов
|Заполняется при evaluationStatus = FINISHED
|numIncorrect
|integer
|-
|Число неверно классифицированных объектов
|Заполняется при evaluationStatus = FINISHED
|pctCorrect
|decimal
|-
|Точность классификатора
|Доля верно классифицированных объектов. Заполняется при evaluationStatus = FINISHED
|pctIncorrect
|decimal
|-
|Ошибка классификатора
|Доля неверно классифицированных объектов. Заполняется при evaluationStatus = FINISHED
|meanAbsoluteError
|decimal
|-
|Средняя абсолютная ошибка классификации
|Заполняется при evaluationStatus = FINISHED
|===

==== 3.14. Пример запроса на создание заявки на эксперимент

[source,json]
----
{
  "trainDataUrl": "http://kt.ijs.si/Branax/Repository/WEKA/Iris.xls",
  "evaluationMethod": "CROSS_VALIDATION",
  "experimentType": "RANDOM_FORESTS"
}
----

==== 3.15. Описание параметров запроса на создание заявки на эксперимент

|===
|Название поля/атрибута|Тип|Обязательное|Описание|Комментарий
|trainDataUrl
|string
|+
|Ссылка на обучающую выборку
|Может быть передана ссылка на внешний источник, например http или ftp, так и ссылка на файл с данными на сервере в формате data://DATA_ID
|evaluationMethod
|string
|+
|Метод оценки точности
|Заполняется по справочнику <<Справочник значений EvaluationMethod>>
|experimentType
|string
|+
|Тип эксперимента
|Заполняется по справочнику <<Справочник значений ExperimentType>>
|===

==== 3.16. Пример ответа на запрос создания заявки на эксперимент

[source,json]
----
{
  "payload": {
    "requestId": "1cbe6c49-8432-4c81-9afa-90f04a803fed",
    "evaluationStatus": "IN_PROGRESS",
    "errorCode": null
  },
  "responseCode": "SUCCESS",
  "errorDescription": null
}
----

Описание полей ответа приведено в п. 3.7.

==== 3.17. Пример запроса на получение результатов эксперимента

[source,bash]
----
curl -X GET "http://localhost:8080/external-api/experiment-results/1cbe6c49-8432-4c81-9afa-90f04a803fed" -H "accept: */*" -H "authorization: Bearer cf4cd583-b9f1-4dce-8dcc-afefd1510974"
----

==== 3.18. Пример ответа на запрос получения результатов эксперимента

[source,json]
----
{
  "payload": {
    "requestId": "1cbe6c49-8432-4c81-9afa-90f04a803fed",
    "evaluationStatus": "FINISHED",
    "errorCode": null,
    "experimentModelUrl": "http://localhost:8098/object-storage/eca-service/experiment-0f45c641-48e1-4f8f-a461-38c27a4befc3.model?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=minio%2F20220727%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20220727T061714Z&X-Amz-Expires=604800&X-Amz-SignedHeaders=host&X-Amz-Signature=2ebb2d403962381a141efaf28767fe3ef622ce1477d9bd2f914560561579325c"
  },
  "responseCode": "SUCCESS",
  "errorDescription": null
}
----

==== 3.19. Описание параметров ответа на запрос получения результатов эксперимента

|===
|Название поля/атрибута|Тип|Обязательное|Описание|Комментарий
|requestId
|string
|+
|Уникальный идентификатор запроса
|
|evaluationStatus
|string
|+
|Статус построения модели
|Заполняется по справочнику <<Справочник кодов EvaluationStatus>>
|responseCode
|string
|+
|Статус ответа
|Заполняется по справочнику <<Справочник кодов ответа>>
|errorCode
|string
|-
|Код ошибки
|
|experimentModelUrl
|string
|-
|Ссылка на скачивание эксперимента из S3. Ссылка действительна в течении 7 дней.
|Заполняется при evaluationStatus = FINISHED
|===

== Справочник значений EvaluationMethod

[options="header"]
|===
|№|Значение|Описание
|1
|TRAINING_DATA
|Использование всей обучающей выборки для оценки точности классификатора
|2
|CROSS_VALIDATION
|Метод k * V - блочной кросс проверки на тестовой выборке
|===

== Справочник кодов ответа

[options="header"]
|===
|№|Код|Описание
|1
|SUCCESS
|Успешный запрос
|2
|VALIDATION_ERROR
|Ошибка валидации
|3
|DATA_NOT_FOUND
|Данные не найдены для заданного url
|4
|ERROR
|Неизвестная ошибка
|5
|TIMEOUT
|Превышено макс. допустимое время выполнения запроса
|6
|SERVICE_UNAVAILABLE
|Сервис недоступен
|===

== Справочник кодов EvaluationStatus

[options="header"]
|===
|№|Код|Описание
|1
|IN_PROGRESS
|Запрос находится в обработке
|2
|FINISHED
|Построение модели завершено
|3
|TIMEOUT
|Таймаут при обработке запроса на построение модели
|4
|ERROR
|Ошибка при построении модели
|===

== Справочник значений ExperimentType

[options="header"]
|===
|№|Код ответа|Описание
|1
|NEURAL_NETWORKS
|Автоматический подбор оптимальных параметров для нейронных сетей
|2
|HETEROGENEOUS_ENSEMBLE
|Автоматический подбор оптимальных параметров для неоднородного ансамблевого алгоритма
|3
|MODIFIED_HETEROGENEOUS_ENSEMBLE
|Автоматический подбор оптимальных параметров для модифицированного неоднородного ансамблевого алгоритма
|4
|ADA_BOOST
|Автоматический подбор оптимальных параметров для алгоритма AdaBoost
|5
|STACKING
|Автоматический подбор оптимальных параметров для алгоритма Stacking
|6
|KNN
|Автоматический подбор оптимальных параметров для алгоритма KNN
|7
|RANDOM_FORESTS
|Автоматический подбор оптимальных параметров для алгоритма RandomForests
|8
|STACKING_CV
|Автоматический подбор оптимальных параметров для алгоритма Stacking CV
|9
|DECISION_TREE
|Автоматический подбор оптимальных параметров для деревьев решений
|===
